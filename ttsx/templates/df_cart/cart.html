{%extends 'base_user.html'%}

{%block header%}
<script>
//    算总金额
    function total() {
        var $total_all = 0;
        $('.cart_list_td').each(function () { //  数量，小计金额
            var $price = parseFloat($(this).children('.col05').text());
            var $count = parseInt($(this).find('.num_show').val());

            var $total = $price*$count;
            $(this).children('.col07').html($total.toFixed(2)+'元'); //　小计金额

//			console.log($price);
//            console.log($count);
//            console.log($total.toFixed(2))
            if($(this).find('input').prop('checked')){
                $total_all+=$total; //  总金额
            }
        });
        $('.total_count em').html($('.cart_list_td').length); //　全部商品数量
        $('.settlements em').html($total_all.toFixed(2)); //  总金额
        $('.settlements b').html($(':checked:not(#check_all)').length); //  选中商品数量
    }

//    删除商品
    function delete_cart(id) {
        if(confirm('确认删除吗？')){
            $.get('/cart/delete_cart/', {'id': id}, function (data) {
                $('#'+id).remove();
                total();
            })
        }

    }

    $(function () {
        total(); // 总计

//        全选，全销
        $('#check_all').click(function () {
            var $checked = $(this).prop('checked'); //　获取#checked_all 的check状态, true or false
            $(':checkbox:not(#check_all)').prop({'checked': $checked});
            total();
        });
//        有一个没选，全选取消, 可以用判断复选框与被选中的复选框个数做对比
        $(':checkbox:not(#check_all)').click(function () {
            var $checkbox_len = $(':checkbox:not(#check_all)').length;
            var $checked_len = $(':checked:not(#check_all)').length;
            if($checkbox_len==$checked_len){
                $('#check_all').prop({'checked': true});
            }
            else{
                $('#check_all').prop({'checked': false});
            }
            total();
        });

//        商品数量的添加，删除，文本自己写数字，算小计
        $('.num_show').blur(function () {
            var $count = parseInt($(this).val());
            var $has = $(this).closest('.col06').siblings('.col03').children('em').text();
//            alert($(this).closest('ul').attr('id'));
            if($count<=1){
                $count = 1;
            }
            else if(isNaN($count)){
                $count = 1;
            }
            else if($count>=$has){
                $count = $has
            }
            $(this).val($count);
            $.get('/cart/edit', {'id': $(this).closest('ul').attr('id'), 'count': $count}, function (data) {
                if(data.ok){
                    total();
                }
            });
//            把价格，数量相乘得到小计
//            判断是否不为数字,小数
        });

//        数量加
        $('.add').click(function () {
            var $num = $(this).next().val();
            $num++;
            $(this).next().val($num).blur();

        });

//        数量减
        $('.minus').click(function () {
            var $num = $(this).prev().val();
            $num--;
            $(this).prev().val($num).blur();
        });

//        提交订单
    })
</script>

{%endblock header%}

{%block body%}
	<div class="total_count">全部商品<em>0</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>
{%for i in list%}
<form action="/cart/order/" method="post">
    {%csrf_token%}

	<ul class="cart_list_td clearfix" id="{{i.id}}">
		<li class="col01"><input type="checkbox" name="cart_id" value="{{i.id}}" checked="checked"></li>
		<li class="col02"><img src="/static/{{i.goods.g_pic}}"></li>
		<li class="col03">{{i.goods.g_name}}<br>剩余库存:<em>{{i.goods.g_has}}</em></li>
		<li class="col04">{{i.goods.g_unit}}</li>
		<li class="col05">{{i.goods.g_price}}</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" class="num_show fl" value="{{i.count}}">
				<a href="javascript:;" class="minus fl">-</a>	
			</div>
		</li>
		<li class="col07"></li>
		<li class="col08"><a href="javascript:void(0);" onclick="delete_cart({{i.id}})">删除</a></li>
	</ul>

{%endfor%}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" checked="checked" id="check_all"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>0</em><br>共计<b>2</b>件商品</li>
		<li class="col04"><input type="submit" value="去结算"></li>
	</ul>
</form>
{%endblock body%}
